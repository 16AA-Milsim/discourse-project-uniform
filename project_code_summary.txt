==== FILE: ./plugin.rb ====
# name: project-uniform
# about: Adds a placeholder image to the user's summary page
# version: 0.1.0
# authors: Daniel Frederiksen

enabled_site_setting :project_uniform_enabled

add_admin_route 'project_uniform.title', 'project-uniform'

register_asset "stylesheets/project-uniform.scss"

Discourse::Application.routes.append do
  get '/admin/plugins/project-uniform' => 'admin/site_settings#index', constraints: StaffConstraint.new, defaults: { filter: 'project uniform' }
end



==== FILE: ./config/locales/en.yml ====
en:
  project_uniform:
    title: "Project Uniform"
    description: "Configure settings for the Project Uniform plugin."


==== FILE: ./config/locales/server.en.yml ====
en:
  site_settings:
    project_uniform_enabled: "Enable Project Uniform"
    project_uniform_admin_only: "Restrict Project Uniform output visibility to Admins Only"

    # Uniforms
    project_uniform_ba_officers_uniform: "BA Officers Uniform"
    project_uniform_ba_enlisted_uniform: "BA Enlisted Uniform"
    project_uniform_raf_officers_uniform: "RAF Officers Uniform"
    project_uniform_raf_enlisted_uniform: "RAF Enlisted Uniform"

    # British Army Ranks
    project_uniform_maj_rank: "Major"
    project_uniform_capt_rank: "Captain"
    project_uniform_lt_rank: "Lieutenant"
    project_uniform_2lt_rank: "Second Lieutenant"
    project_uniform_wo1_rank: "Warrant Officer Class 1"
    project_uniform_wo2_rank: "Warrant Officer Class 2"
    project_uniform_csgt_ssgt_rank: "Colour Sergeant / Staff Sergeant"
    project_uniform_sgt_rank: "Sergeant"
    project_uniform_cpl_bdr_rank: "Corporal / Bombardier"
    project_uniform_lcpl_lbdr_rank: "Lance Corporal / Lance Bombardier"
    project_uniform_pte_gnr_rank: "Private / Gunner"
    project_uniform_rec_rank: "Recruit"

    # RAF Ranks
    project_uniform_sqn_ldr_rank: "Squadron Leader"
    project_uniform_flt_lt_rank: "Flight Lieutenant"
    project_uniform_fg_off_rank: "Flying Officer"
    project_uniform_plt_off_rank: "Pilot Officer"
    project_uniform_fsacr_rank: "Flight Sergeant Aircrew"
    project_uniform_sacr_rank: "Sergeant Aircrew"

    # Berets
    project_uniform_para_beret: "Parachute Regiment Beret"
    project_uniform_recruit_beret: "Recruit Beret"

    # Cap Badges
    project_uniform_para_badge: "Parachute Regiment Badge"
    project_uniform_ramc_badge: "Royal Army Medical Corps Badge"

    # Lanyards
    project_uniform_hq_lanyard: "HQ Lanyard"
    project_uniform_1_platoon_lanyard: "1 Platoon Lanyard"
    project_uniform_2_platoon_lanyard: "2 Platoon Lanyard"
    project_uniform_fsg_lanyard: "FSG Lanyard"
    project_uniform_csm_group_lanyard: "CSM Group Lanyard"
    project_uniform_16csmr_lanyard: "16CSMR Lanyard"
    project_uniform_216ps_lanyard: "216PS Lanyard"
    project_uniform_fst_lanyard: "FST Lanyard"
    project_uniform_7rha_lanyard: "7RHA Lanyard"

    # Qualifications
    project_uniform_paratrooper_qualification: "Paratrooper Qualification"

  js:
    project_uniform:
      title: "Project Uniform"



==== FILE: ./config/locales/client.en.yml ====
en:
  js:
    project_uniform:
      title: "Project Uniform"



==== FILE: ./config/settings.yml ====
plugins:
  project_uniform_enabled:
    type: boolean
    default: true
    client: true
  project_uniform_admin_only:
    type: boolean
    default: false
    client: true

  # Uniforms
  project_uniform_ba_officers_uniform:
    type: upload
    default: ""
    client: true
  project_uniform_ba_enlisted_uniform:
    type: upload
    default: ""
    client: true
  project_uniform_raf_officers_uniform:
    type: upload
    default: ""
    client: true
  project_uniform_raf_enlisted_uniform:
    type: upload
    default: ""
    client: true

  # British Army Ranks
  project_uniform_maj_rank:
    type: upload
    default: ""
    client: true
  project_uniform_capt_rank:
    type: upload
    default: ""
    client: true
  project_uniform_lt_rank:
    type: upload
    default: ""
    client: true
  project_uniform_2lt_rank:
    type: upload
    default: ""
    client: true
  project_uniform_wo1_rank:
    type: upload
    default: ""
    client: true
  project_uniform_wo2_rank:
    type: upload
    default: ""
    client: true
  project_uniform_csgt_ssgt_rank:
    type: upload
    default: ""
    client: true
  project_uniform_sgt_rank:
    type: upload
    default: ""
    client: true
  project_uniform_cpl_bdr_rank:
    type: upload
    default: ""
    client: true
  project_uniform_lcpl_lbdr_rank:
    type: upload
    default: ""
    client: true
  project_uniform_pte_gnr_rank:
    type: upload
    default: ""
    client: true
  project_uniform_rec_rank:
    type: upload
    default: ""
    client: true

  # RAF Ranks
  project_uniform_sqn_ldr_rank:
    type: upload
    default: ""
    client: true
  project_uniform_flt_lt_rank:
    type: upload
    default: ""
    client: true
  project_uniform_fg_off_rank:
    type: upload
    default: ""
    client: true
  project_uniform_plt_off_rank:
    type: upload
    default: ""
    client: true
  project_uniform_fsacr_rank:
    type: upload
    default: ""
    client: true
  project_uniform_sacr_rank:
    type: upload
    default: ""
    client: true

  # Berets
  project_uniform_para_beret:
    type: upload
    default: ""
    client: true
  project_uniform_recruit_beret:
    type: upload
    default: ""
    client: true

  # Cap Badges
  project_uniform_para_badge:
    type: upload
    default: ""
    client: true
  project_uniform_rams_badge:
    type: upload
    default: ""
    client: true

  # Lanyards
  project_uniform_hq_lanyard:
    type: upload
    default: ""
    client: true
  
  project_uniform_1_platoon_lanyard:
    type: upload
    default: ""
    client: true

  project_uniform_2_platoon_lanyard:
    type: upload
    default: ""
    client: true
  
  project_uniform_fsg_lanyard:
    type: upload
    default: ""
    client: true
  
  project_uniform_csm_group_lanyard:
    type: upload
    default: ""
    client: true
  
  project_uniform_16csmr_lanyard:
    type: upload
    default: ""
    client: true
  
  project_uniform_216ps_lanyard:
    type: upload
    default: ""
    client: true

  project_uniform_fst_lanyard:
    type: upload
    default: ""
    client: true
  
  project_uniform_7rha_lanyard:
    type: upload
    default: ""
    client: true

  # Qualifications
  project_uniform_paratrooper_qualification:
    type: upload
    default: ""
    client: true


==== FILE: ./assets/stylesheets/project-uniform.scss ====
.image-row-container {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap; /* This ensures wrapping of items when more than 4 per row */
    width: 100%; /* Allow the container to be flexible */
    width: 940px; /* Optional: You can limit the maximum width for better control */
}

.image-container {
    flex: 1 1 calc(25%); /* Flex-basis 25% minus the gap to allow for four columns */
    box-sizing: border-box;
    margin-bottom: 20px; /* Optional: Adjust to control vertical spacing */
}

.image-upload-btn, .btn, .btn-danger {
    border: 1px solid rgba(0, 0, 0, 0);
    font-size: var(--font-0);
    line-height: normal;
    box-sizing: border-box;
    padding: .5em .65em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    font-weight: normal;
    border-radius: var(--d-button-border-radius);
    transition: var(--d-button-transition);
    cursor: pointer;
}

.image-upload-btn {
    color: var(--primary);
    background-color: #6d6d6d;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0));
    position: absolute;
    top: 5px;
    left: 5px;
    z-index: 10;
}

.btn-danger {
    color: var(--secondary);
    background-color: var(--danger);
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0));
}

.btn-danger:hover svg {
    fill: rgb(83, 83, 83); /* Change to your desired color */
}

.btn-danger .d-icon{
    color: #ccc;
}

.image-upload-btn svg, .btn svg {
    vertical-align: middle;
}

.image-upload-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
}

.hidden-upload-field {
    display: none;
}

.image-wrapper {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
}

.image-preview {
    flex: 0 0 auto;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 200px;
    height: 150px;
    overflow: hidden;
    background-color: #969696;
    box-sizing: border-box;
}

.image-preview__img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}



==== FILE: ./assets/javascripts/discourse/project-uniform-route-map.js ====
export default {
  resource: 'admin.adminPlugins',
  path: '/plugins',
  map() {
    // No routes defined since we are removing the admin page for project-uniform
  }
};



==== FILE: ./assets/javascripts/discourse/initializers/intializers.js.es6 ====
import { withPluginApi } from 'discourse/lib/plugin-api';

export default {
  name: 'project-uniform',
  initialize(container) {
    withPluginApi('0.8.26', api => {
      const siteSettings = container.lookup('site-settings:main');

      api.onPageChange(url => {
        if (url && url.includes('/u/') && url.includes('/summary')) {
          const container = document.querySelector('.user-content');
          if (container && !document.querySelector('.project-uniform-placeholder')) {
            // Check if admin-only mode is enabled
            if (siteSettings.project_uniform_admin_only) {
              const currentUser = Discourse.User.current();
              if (!currentUser || !currentUser.admin) {
                console.log('Project Uniform: Admin-only mode is enabled. Hiding uniforms for non-admin users.');
                return; // Do not render anything for non-admin users
              }
            }

            // Extract username from URL
            const username = url.split('/u/')[1].split('/')[0];
            const apiUrl = `/u/${username}.json`;

            // Define enlisted and officer ranks
            const enlistedRanks = [
              'Recruit',
              'Private',
              'Acting_Lance_Corporal',
              'Lance_Corporal',
              'Acting_Corporal',
              'Corporal',
              'Acting_Sergeant',
              'Sergeant',
              'Staff_Sergeant',
              'Colour_Sergeant',
              'Warrant_Officer_Class_2'
            ];

            const officerRanks = [
              'Acting_Second_Lieutenant',
              'Second_Lieutenant',
              'Lieutenant',
              'Captain',
              'Major'
            ];

            // Fetch user data
            fetch(apiUrl)
              .then(response => response.ok ? response.json() : Promise.reject(response.statusText))
              .then(userData => {
                if (userData?.user) {
                  const { user, user_badges = [], badges = [] } = userData;
                  const groups = user.groups || [];

                  // Extract badge names
                  const badgeNames = user_badges.map(ub => badges.find(b => b.id === ub.badge_id)?.name || 'Unnamed Badge');

                  // Display user information
                  const userInfo = createUserInfo(groups, badgeNames);
                  container.prepend(userInfo);

                  // Retrieve and format uploaded image URLs
                  let backgroundImageUrl = '';
                  const foregroundImageUrls = []; // Array to hold multiple foreground images

                  // Determine the background image
                  if (groups.some(group => enlistedRanks.includes(group.name))) {
                    backgroundImageUrl = formatUrl(siteSettings.project_uniform_ba_enlisted_uniform);
                    console.log('Selected Enlisted Uniform:', backgroundImageUrl);
                  } else if (groups.some(group => officerRanks.includes(group.name))) {
                    backgroundImageUrl = formatUrl(siteSettings.project_uniform_ba_officers_uniform);
                    console.log('Selected Officer Uniform:', backgroundImageUrl);
                  } else {
                    console.warn('User does not belong to enlisted or officer ranks. No uniform assigned.');
                  }

                  // Add foreground images for berets and ranks
                  if (groups.some(group => group.name === 'Recruit')) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_recruit_beret));
                  } else if (
                    groups.some(group =>
                      enlistedRanks.includes(group.name) && group.name !== 'Recruit' ||
                      officerRanks.includes(group.name)
                    )
                  ) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_para_beret));
                  }

                  // Add rank-specific images
                  if (groups.some(group => group.name === 'Sergeant')) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_sgt_rank));
                  }
                  if (groups.some(group => group.name === 'Corporal')) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_cpl_bdr_rank));
                  }
                  if (groups.some(group => group.name === 'Lance_Corporal')) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_lcpl_lbdr_rank));
                  }
                  if (groups.some(group => group.name === 'Major')) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_maj_rank));
                  }

                  // Add qualification-specific images
                  if (user_badges.some(ub => badges.find(b => b.id === ub.badge_id)?.name === 'Paratrooper')) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_paratrooper_qualification));
                  }

                  // Add lanyard-specific images based on groups
                  if (
                    groups.some(group =>
                      [
                        "1_Platoon_IC",
                        "1_Platoon_2IC",
                        "1-1_Section",
                        "1-2_Section",
                        "1-3_Section"
                      ].includes(group.name)
                    )
                  ) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_1_platoon_lanyard));
                  }

                  if (
                    groups.some(group =>
                      [
                        "Fire_Support_Group_IC",
                        "Fire_Support_Group_2IC",
                        "Fire_Support_Group"
                      ].includes(group.name)
                    )
                  ) {
                    foregroundImageUrls.push(formatUrl(siteSettings.project_uniform_fsg_lanyard));
                  }

                  // Filter out invalid URLs
                  const validForegroundImageUrls = foregroundImageUrls.filter(url => url);

                  // Log selected images for debugging
                  console.log('Background Image URL:', backgroundImageUrl);
                  console.log('Foreground Image URLs:', validForegroundImageUrls);

                  // Create and merge images on a canvas
                  if (backgroundImageUrl && validForegroundImageUrls.length > 0) {
                    mergeImagesOnCanvas(container, backgroundImageUrl, validForegroundImageUrls);
                  } else {
                    console.warn('No valid images found to render.');
                  }
                }
              })
              .catch(error => console.error('Error fetching user data:', error));
          }
        }
      });
    });
  }
};

function createUserInfo(groups, badgeNames) {
  const userInfo = document.createElement('div');
  userInfo.style.textAlign = 'center';
  userInfo.style.marginBottom = '10px';
  userInfo.className = 'project-uniform-user-info';

  const groupsElement = document.createElement('p');
  groupsElement.textContent = `Groups: ${groups.map(group => group.name).join(', ') || 'None'}`;

  const badgesElement = document.createElement('p');
  badgesElement.textContent = `Badges: ${badgeNames.length > 0 ? badgeNames.join(', ') : 'None'}`;

  userInfo.appendChild(groupsElement);
  userInfo.appendChild(badgesElement);

  return userInfo;
}

function formatUrl(url) {
  if (!url) return ''; // Handle undefined or null URLs
  return url.startsWith('http') || url.startsWith('/')
    ? url
    : `${window.location.origin}/${url}`;
}

function mergeImagesOnCanvas(container, backgroundImageUrl, foregroundImageUrls) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  const bgImage = new Image();
  const fgImages = foregroundImageUrls.map(url => new Image());
  let imagesLoaded = 0;

  const onImageLoad = () => {
    imagesLoaded++;
    if (imagesLoaded === 1 + fgImages.length) {
      // Set canvas size and draw images
      canvas.width = bgImage.naturalWidth || 1;
      canvas.height = bgImage.naturalHeight || 1;

      // Add drop shadow for the background image
      ctx.save(); // Save the current canvas state
      ctx.shadowColor = 'rgba(0, 0, 0, 0.4)'; // Shadow color
      ctx.shadowBlur = 10; // Shadow blur radius
      ctx.shadowOffsetX = 1; // Horizontal shadow offset
      ctx.shadowOffsetY = 1; // Vertical shadow offset

      // Draw the background image with shadow
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
      ctx.restore(); // Restore canvas state to prevent shadow on other drawings

      // Draw foreground images
      fgImages.forEach(fgImage => {
        const fgWidth = fgImage.naturalWidth || 0;
        const fgHeight = fgImage.naturalHeight || 0;
        const fgX = (canvas.width - fgWidth) / 2;
        const fgY = (canvas.height - fgHeight) / 2;
        if (fgWidth > 0 && fgHeight > 0) {
          ctx.drawImage(fgImage, fgX, fgY, fgWidth, fgHeight);
        }
      });

      // Display the merged image
      const mergedImage = createImageElement(canvas.toDataURL('image/png'), 'Merged Project Uniform Image');
      container.prepend(mergedImage);
    }
  };

  bgImage.onload = onImageLoad;
  fgImages.forEach(fgImage => (fgImage.onload = onImageLoad));

  bgImage.src = backgroundImageUrl || '';
  fgImages.forEach((fgImage, index) => (fgImage.src = foregroundImageUrls[index] || ''));
}


function createImageElement(src, alt) {
  const img = document.createElement('img');
  img.src = src;
  img.alt = alt;
  img.style.display = 'block';
  img.style.margin = '0 auto';
  return img;
}


